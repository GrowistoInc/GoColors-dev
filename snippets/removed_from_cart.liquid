<script>
(function () {
  const originalFetch = window.fetch;
  let previousCart = null;

  async function getCart() {
    const res = await fetch('/cart.js');
    return await res.json();
  }

  // Initialize cart snapshot
  getCart().then(cart => previousCart = cart);

  window.fetch = function (url, options = {}) {
    return originalFetch.apply(this, arguments).then(async response => {

      try {
        if (
          typeof url === 'string' &&
          (url.includes('/cart/change') || url.includes('/cart/update'))
        ) {

          if (!previousCart) return response;

          let removedVariantId = null;
          let newQty = null;

          /* ---------- HANDLE BODY TYPES ---------- */

          if (options.body instanceof FormData) {
            removedVariantId = options.body.get('id');
            newQty = Number(options.body.get('quantity'));
          }

          else if (typeof options.body === 'string') {
            const params = new URLSearchParams(options.body);
            removedVariantId = params.get('id');
            newQty = Number(params.get('quantity'));
          }

          else if (options.headers?.['Content-Type']?.includes('application/json')) {
            const body = JSON.parse(options.body);
            if (body.id) {
              removedVariantId = body.id;
              newQty = Number(body.quantity);
            }
            if (body.updates) {
              removedVariantId = Object.keys(body.updates)[0];
              newQty = body.updates[removedVariantId];
            }
          }

          if (!removedVariantId) return response;

          const previousItem = previousCart.items.find(
            i => i.variant_id.toString() === removedVariantId.toString()
          );

          if (!previousItem) return response;

          const removedQty =
            newQty === 0
              ? previousItem.quantity
              : Math.max(previousItem.quantity - newQty, 1);

          const ga4Item = {
            item_id: previousItem.variant_id.toString(),
            item_name: previousItem.product_title,
            item_brand: previousItem.vendor || "",
            item_category: previousItem.product_type || "",
            item_variant: previousItem.variant_title || "",
            price: previousItem.price / 100,
            quantity: removedQty,
            affiliation: "Online Store"
          };

          window.dataLayer = window.dataLayer || [];
          window.dataLayer.push({
            event: 'remove_from_cart',
            currency: previousCart.currency || 'INR',
            value: ga4Item.price * ga4Item.quantity,
            items: [ga4Item]
          });

          console.log('âœ… remove_from_cart (exact)', ga4Item);

          // Update cart snapshot AFTER removal
          setTimeout(async () => {
            previousCart = await getCart();
          }, 300);
        }

      } catch (e) {
        console.error('remove_from_cart error', e);
      }

      return response;
    });
  };
})();
</script>
