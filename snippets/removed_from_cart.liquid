<script>
(function () {
  const originalFetch = window.fetch;
  let previousCart = null;

  // Always keep latest cart snapshot
  async function updatePreviousCart() {
    try {
      const res = await fetch('/cart.js');
      previousCart = await res.json();
    } catch (e) {}
  }

  updatePreviousCart();

  window.fetch = function () {
    return originalFetch.apply(this, arguments).then(async response => {

      try {
        const url = arguments[0];

        if (
          typeof url === 'string' &&
          (url.includes('/cart/change') || url.includes('/cart/update'))
        ) {

          const requestBody = arguments[1]?.body;
          if (!requestBody || !previousCart) return response;

          const params = new URLSearchParams(requestBody);
          const removedVariantId = params.get('id');
          const newQty = Number(params.get('quantity'));

          // Find item BEFORE removal
          const previousItem = previousCart.items.find(
            item => item.variant_id.toString() === removedVariantId
          );

          if (!previousItem) return response;

          const removedQty =
            newQty === 0
              ? previousItem.quantity
              : Math.max(previousItem.quantity - newQty, 1);

          const ga4Item = {
            item_id: previousItem.variant_id.toString(),
            item_name: previousItem.product_title,
            item_brand: previousItem.vendor || "",
            item_category: previousItem.product_type || "",
            item_variant: previousItem.variant_title || "",
            price: previousItem.price / 100,
            quantity: removedQty,
            affiliation: "Online Store"
          };

          window.dataLayer = window.dataLayer || [];
          window.dataLayer.push({
            event: 'remove_from_cart',
            currency: previousCart.currency || 'INR',
            value: ga4Item.price * ga4Item.quantity,
            items: [ga4Item]
          });

          console.log('ðŸŸ¥ GA4 remove_from_cart (exact)', ga4Item);

          // Update snapshot AFTER removal
          setTimeout(updatePreviousCart, 300);
        }
      } catch (e) {
        console.error('remove_from_cart error', e);
      }

      return response;
    });
  };
})();
</script>
