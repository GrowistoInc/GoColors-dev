<script>
(function () {

  let cartSnapshot = null;

  async function fetchCart() {
    const res = await fetch('/cart.js');
    return await res.json();
  }

  // Keep cart snapshot updated
  fetchCart().then(cart => cartSnapshot = cart);

  document.addEventListener('click', async function (e) {
    const removeBtn = e.target.closest('.cart-remove-button');
    if (!removeBtn) return;

    if (!cartSnapshot || !cartSnapshot.items) return;

    /* -------------------------
       GET VARIANT ID
       ------------------------- */

    const variantId =
      removeBtn.dataset.variantId ||
      removeBtn.getAttribute('data-variant-id') ||
      removeBtn.value;

    if (!variantId) {
      console.warn('Remove button clicked but variant_id not found');
      return;
    }

    /* -------------------------
       FIND ITEM IN CART
       ------------------------- */

    const item = cartSnapshot.items.find(
      i => i.variant_id.toString() === variantId.toString()
    );

    if (!item) return;

    /* -------------------------
       GA4 ITEM
       ------------------------- */

    const ga4Item = {
      item_id: lastItem.variant_id.toString(),
            item_name: lastItem.product_title,
            item_brand: lastItem.vendor || "",
            coupon: cart.cart_level_discount_applications?.[0]?.title || "",            
            item_category: lastItem.product_type || "",            
            item_variant: lastItem.variant_title || "",
            location_id: "online_store",
            price: lastItem.price / 100,
            quantity: lastItem.quantity,
            affiliation: "Online Store",
            discount:lastItem.total_discount
    };

    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
      event: 'remove_from_cart',
      currency: cartSnapshot.currency || 'INR',
      value: ga4Item.price * ga4Item.quantity,
      items: [ga4Item]
    });

    console.log('âœ… remove_from_cart (click-based exact)', ga4Item);

    /* -------------------------
       UPDATE CART SNAPSHOT AFTER REMOVE
       ------------------------- */
    setTimeout(async () => {
      cartSnapshot = await fetchCart();
    }, 500);
  });

})();
</script>
