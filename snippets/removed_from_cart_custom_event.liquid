{% comment %} <script>
(function () {

  let cartSnapshot = null;

  async function fetchCart() {
    const res = await fetch('/cart.js');
    return await res.json();
  }

  // Keep cart snapshot updated
  fetchCart().then(cart => cartSnapshot = cart);

  document.addEventListener('click', async function (e) {
    const removeBtn = e.target.closest('.cart-remove-button');
    if (!removeBtn) return;

    if (!cartSnapshot || !cartSnapshot.items) return;

    /* -------------------------
       GET VARIANT ID
       ------------------------- */

    const variantId =
      removeBtn.dataset.variantId ||
      removeBtn.getAttribute('data-variant-id') ||
      removeBtn.value;

    if (!variantId) {
      console.warn('Remove button clicked but variant_id not found');
      return;
    }

    const item = cartSnapshot.items.find(
      i => i.variant_id.toString() === variantId.toString()
    );

    if (!item) return;
    

    const ga4Item = {
      item_id: item.variant_id.toString(),
      item_name: item.product_title,
      item_brand: item.vendor || "",
      item_category: item.product_type || "",
      item_variant: item.variant_title || "",
      price: item.price / 100,
      quantity: item.quantity,
      affiliation: "Online Store"
    };

    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
      event: 'remove_from_cart',
      currency: cartSnapshot.currency || 'INR',
      value: ga4Item.price * ga4Item.quantity,
      items: [ga4Item]
    });

    console.log('âœ… remove_from_cart (click-based exact)', ga4Item);

    /* -------------------------
       UPDATE CART SNAPSHOT AFTER REMOVE
       ------------------------- */
    setTimeout(async () => {
      cartSnapshot = await fetchCart();
    }, 500);
  });

})();
</script> {% endcomment %}



<script>
(function () {

  async function fetchCart() {
    const res = await fetch('/cart.js');
    return await res.json();
  }

  document.addEventListener('click', async function (e) {

    /* ðŸ”¹ UNIVERSAL REMOVE BUTTON DETECTION */
    const removeBtn = e.target.closest(
      '[data-variant-id], button[name="remove"], .cart-remove-button, a[href*="quantity=0"]'
    );
    if (!removeBtn) return;

    const variantId =
      removeBtn.dataset.variantId ||
      removeBtn.value ||
      removeBtn.getAttribute('data-variant-id');

    if (!variantId) return;

    /* ðŸ”¹ GET LATEST CART (BEFORE REMOVE) */
    const cart = await fetchCart();
    if (!cart?.items?.length) return;

    const item = cart.items.find(
      i => i.variant_id.toString() === variantId.toString()
    );

    if (!item) return;
    console.log('item', item );
    const ga4Item = {
      item_id: item.variant_id.toString(),
      item_name: item.product_title,
      item_brand: item.vendor || "",
      item_category: item.product_type || "",
      item_variant: item.variant_title || "Default Title",
      price: item.final_price / 100,
      quantity: item.quantity,
      discount : item.total_discount,       
      affiliation: "Online Store"
    };

    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
      event: 'remove_from_cart',
      currency: cart.currency || 'INR',
      value: (item.final_price / 100) * item.quantity,
      ecommerce: {
        items: [ga4Item]
      }
    });

    console.log('âœ… remove_from_cart fired', ga4Item);
  });

})();
</script>
