{% comment %} GA4 view_item_list via dataLayer with incognito detection {% endcomment %}
<script>
document.addEventListener("DOMContentLoaded", function () {

  {% if collection %}

  const listId = "{{ collection.id }}";
  const listName = "{{ collection.title | escape }}";

  const items = [
    {% for product in collection.products %}
    {
      item_id: "{{ product.id }}",
      item_name: "{{ product.title | escape }}",
      affiliation: "Online Store",
      coupon: "",
      discount: 0,
      index: {{ forloop.index }},
      item_brand: "{{ product.vendor | escape }}",
      item_category: "{{ collection.title | escape }}",
      item_category2: "{{ collection.handle }}",
      item_category3: "NA",
      item_category4: "NA",
      item_category5: "NA",
      item_list_id: "{{ collection.id }}",
      item_list_name: "{{ collection.title | escape }}",
      item_variant: "{{ product.selected_or_first_available_variant.title | escape }}",
      location_id: "online_store",
      price: {{ product.price | money_without_currency | replace: ',', '' }},
      quantity: 1
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ];

  function pushViewItemList(incognitoValue) {
    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
      event: "view_item_list",
      incognito_window: incognitoValue,
      currency: "{{ cart.currency.iso_code | default: 'INR' }}",
      item_list_id: listId,
      item_list_name: listName,
      items: items
    });

    console.log("âœ… view_item_list pushed to dataLayer", {
      incognito_window: incognitoValue,
      items: items
    });
  }

  // ---- Incognito detection (safe fallback) ----
  if (typeof detectIncognito === "function") {
    detectIncognito().then(result => {
      pushViewItemList(result.isPrivate ? 1 : 0);
    });
  } else {
    // fallback if library not loaded
    pushViewItemList(0);
  }

  {% endif %}

});
</script>
