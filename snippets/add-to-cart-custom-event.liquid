<script>
(function () {
  const originalFetch = window.fetch;

  window.fetch = function () {
    return originalFetch.apply(this, arguments).then(async response => {

      try {
        if (arguments[0].includes('/cart/add')) {

          const cartRes = await fetch('/cart.js');
          const cart = await cartRes.json();

          if (!cart.items || !cart.items.length) return response;

          const lastItem = cart.items[cart.items.length - 1];
          console.log('lastItem');
          const ga4Item = {
            item_id: lastItem.variant_id.toString(),
            item_name: lastItem.product_title,
            item_brand: lastItem.vendor || "",
            coupon: cart.cart_level_discount_applications?.[0]?.title || "",
            
            item_category: lastItem.product_type || "",
            
            item_variant: lastItem.variant_title || "",
            location_id: "online_store",
            price: lastItem.price / 100,
            quantity: lastItem.quantity,
            affiliation: "Online Store"
          };

          window.dataLayer = window.dataLayer || [];
          window.dataLayer.push({
            event: 'add_to_cart',
            currency: cart.currency || 'INR',
            value: (lastItem.price / 100) * lastItem.quantity,
            items: [ga4Item]
          });

          console.log('âœ… GA4 add_to_cart fired', ga4Item);
        }
      } catch (e) {
        console.error('GA4 add_to_cart error', e);
      }

      return response;
    });
  };
})();
</script>
