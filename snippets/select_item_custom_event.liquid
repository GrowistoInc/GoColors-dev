<script>
document.addEventListener("click", function (e) {

  const productCard = e.target.closest(".card-wrapper");
  if (!productCard) return;

  const productLink = productCard.querySelector('a[href*="/products/"]');
  if (!productLink) return;

  const productName =
    productCard.querySelector(".similar-product-title a")?.innerText.trim() ||
    productCard.querySelector(".card__heading a")?.innerText.trim() ||
    "NA";

  const priceText =
    productCard.querySelector(".price-item--sale")?.innerText ||
    productCard.querySelector(".price-item--regular")?.innerText ||
    "";

  const price = Number(priceText.replace(/[^0-9.]/g, ""));
  const productUrl = productLink.getAttribute("href");

  /* ✅ COLLECTIONS — PRODUCT SPECIFIC */
  const collectionsValue = productCard.dataset.collections || "";

  const collectionsArr = collectionsValue
    .split(',')
    .map(v => v.trim())
    .filter(Boolean);

  /* ✅ GA4 CATEGORY MAPPING */
  const itemCategories = {};

  collectionsArr.forEach((value, index) => {
    if (index === 0) {
      itemCategories.item_category = value;
    } else if (index < 5) {
      itemCategories[`item_category${index + 1}`] = value;
    }
  });

  console.log("collectionsArr =>", collectionsArr);
  console.log("itemCategories =>", itemCategories);

  const item = {
    item_id: productUrl.split("/products/")[1],
    item_name: productName,
    affiliation: "{{ shop.name }}",
    item_brand: "{{ shop.name }}",
    price: price,
    quantity: 1,
    item_list_id: "collection_page",
    item_list_name: "{{ collection.title | default: 'Collection' }}",
    location_id: window.location.href,

    ...itemCategories // ✅ MUST be last
  };

  window.dataLayer = window.dataLayer || [];
  window.dataLayer.push({
    event: "select_item",
    ecommerce: {
      items: [item]
    }
  });

  console.log("✅ select_item fired", item);
});
</script>
